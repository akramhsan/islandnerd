
<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Island Nerd</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/css/styles.css" rel="stylesheet">
  <style>
    .sidebar { position: sticky; top: 1rem; }
    .editor { position: sticky; top: 1rem; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="../index.html">
      <img src="../images/logo.png" alt="Island Nerd logo" width="32" height="32" class="rounded-circle">
      <span class="fw-bold">Island Nerd — Admin</span>
    </a>
  </div>
</nav>

<main class="container py-4">
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="sidebar p-3 bg-light rounded-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Posts</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" id="newPostBtn">New</button>
            <button class="btn btn-sm btn-outline-secondary" id="importBtn">Import JSON</button>
            <button class="btn btn-sm btn-outline-success" id="exportBtn">Export JSON</button>
          </div>
        </div>
        <input id="listSearch" class="form-control form-control-sm mb-2" placeholder="Search posts…">
        <div id="postsList" class="list-group small"></div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="editor p-3 bg-white border rounded-4 shadow-soft">
        <h2 class="h6 mb-3">Editor</h2>
        <form id="postForm" class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Title</label>
            <input class="form-control" id="title" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Slug</label>
            <input class="form-control monospace" id="slug" placeholder="auto-from-title">
          </div>

          <div class="col-md-4">
            <label class="form-label">Type</label>
            <select class="form-select" id="type">
              <option value="guide">guide</option>
              <option value="review">review</option>
              <option value="video">video</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="date">
          </div>
          <div class="col-md-4">
            <label class="form-label">Reading Time / Duration</label>
            <input class="form-control" id="readingTime" placeholder="e.g., 6 min or 8:42">
          </div>

          <div class="col-12">
            <label class="form-label">Tags</label>
            <input class="form-control" id="tagsInput" placeholder="Type tag and press Enter">
            <div id="tagsChips" class="mt-2"></div>
          </div>

          <div class="col-12">
            <label class="form-label">Summary</label>
            <textarea class="form-control" id="summary" rows="2"></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Content (HTML allowed)</label>
            <textarea class="form-control monospace" id="content" rows="8"></textarea>
          </div>

          <div class="col-md-8">
            <label class="form-label">Thumbnail URL</label>
            <input class="form-control" id="thumbnail">
          </div>
          <div class="col-md-4">
            <label class="form-label">YouTube ID (for videos)</label>
            <input class="form-control monospace" id="youtubeId" placeholder="e.g., dQw4w9WgXcQ">
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" id="saveBtn">Save</button>
            <button class="btn btn-outline-danger" id="deleteBtn" type="button">Delete</button>
            <button class="btn btn-outline-secondary" id="resetBtn" type="reset">Reset</button>
          </div>
        </form>
        <p class="small text-muted mt-3">Changes are kept locally until you click <strong>Export JSON</strong>, then replace <code>content/posts.json</code> in your repo.</p>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Simple client-side CMS for posts.json
let posts = [];
let currentIndex = -1;
let tags = [];

const postsList = document.getElementById('postsList');
const listSearch = document.getElementById('listSearch');
const form = document.getElementById('postForm');
const fields = {
  title: document.getElementById('title'),
  slug: document.getElementById('slug'),
  type: document.getElementById('type'),
  date: document.getElementById('date'),
  readingTime: document.getElementById('readingTime'),
  summary: document.getElementById('summary'),
  content: document.getElementById('content'),
  thumbnail: document.getElementById('thumbnail'),
  youtubeId: document.getElementById('youtubeId')
};
const tagsInput = document.getElementById('tagsInput');
const tagsChips = document.getElementById('tagsChips');

function slugify(s){
  return s.toLowerCase().trim()
    .replace(/[^a-z0-9\s-]/g,'')
    .replace(/\s+/g,'-')
    .replace(/-+/g,'-')
    .replace(/^-+|-+$/g,'');
}

function renderList(filter=''){
  const q = filter.toLowerCase();
  postsList.innerHTML = posts.map((p,i)=>{
    const hay = (p.title + ' ' + (p.tags||[]).join(' ') + ' ' + (p.summary||'')).toLowerCase();
    if (q && !hay.includes(q)) return '';
    return `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-index="${i}">
      <span class="text-start">
        <div class="fw-semibold">${p.title}</div>
        <small class="text-muted">${p.type} • ${p.date}</small>
      </span>
      <span class="badge text-bg-light">${(p.tags||[]).length}</span>
    </button>`;
  }).join('') || '<div class="text-muted small">No posts yet</div>';
}

function loadPost(i){
  currentIndex = i;
  const p = posts[i];
  if (!p) return;
  fields.title.value = p.title || '';
  fields.slug.value = p.slug || '';
  fields.type.value = p.type || 'guide';
  fields.date.value = p.date || '';
  fields.readingTime.value = p.readingTime || p.duration || '';
  fields.summary.value = p.summary || '';
  fields.content.value = p.content || '';
  fields.thumbnail.value = p.thumbnail || '';
  fields.youtubeId.value = p.youtubeId || '';
  tags = [...(p.tags||[])];
  renderTags();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderTags(){
  tagsChips.innerHTML = tags.map((t,i)=>`
    <span class="input-chip">${t} <button type="button" aria-label="Remove tag" onclick="removeTag(${i})">×</button></span>
  `).join('');
}

window.removeTag = function(i){
  tags.splice(i,1); renderTags();
}

tagsInput.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){
    e.preventDefault();
    const val = tagsInput.value.trim();
    if (val && !tags.includes(val)) tags.push(val);
    tagsInput.value=''; renderTags();
  }
});

postsList.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-index]');
  if (!btn) return;
  loadPost(parseInt(btn.dataset.index, 10));
});

listSearch.addEventListener('input', ()=>renderList(listSearch.value));

document.getElementById('newPostBtn').addEventListener('click', ()=>{
  const blank = { title:'', slug:'', type:'guide', tags:[], date:new Date().toISOString().slice(0,10), readingTime:'5 min', summary:'', content:'', thumbnail:'' };
  posts.unshift(blank);
  renderList(listSearch.value);
  loadPost(0);
  fields.title.focus();
});

document.getElementById('deleteBtn').addEventListener('click', ()=>{
  if (currentIndex < 0) return;
  if (!confirm('Delete this post?')) return;
  posts.splice(currentIndex,1);
  currentIndex = -1;
  form.reset(); tags=[]; renderTags();
  renderList(listSearch.value);
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (currentIndex >= 0) loadPost(currentIndex);
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  // apply current form to posts[currentIndex] before export
  if (currentIndex >= 0) applyFormToCurrent();
  const blob = new Blob([JSON.stringify(posts, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'posts.json';
  a.click();
});

document.getElementById('importBtn').addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'application/json';
  inp.onchange = ()=>{
    const file = inp.files[0]; if (!file) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try {
        posts = JSON.parse(fr.result);
        renderList(); currentIndex = -1; form.reset(); tags=[]; renderTags();
      } catch(e){ alert('Invalid JSON'); }
    };
    fr.readAsText(file);
  };
  inp.click();
});

function applyFormToCurrent(){
  const p = posts[currentIndex]; if (!p) return;
  p.title = fields.title.value.trim();
  p.slug = (fields.slug.value.trim() || slugify(p.title));
  p.type = fields.type.value;
  p.date = fields.date.value || new Date().toISOString().slice(0,10);
  const rt = fields.readingTime.value.trim();
  if (p.type === 'video') { p.duration = rt; delete p.readingTime; }
  else { p.readingTime = rt; delete p.duration; }
  p.summary = fields.summary.value.trim();
  p.content = fields.content.value;
  p.thumbnail = fields.thumbnail.value.trim();
  p.youtubeId = fields.youtubeId.value.trim();
  p.tags = tags.slice();
}

document.getElementById('saveBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  if (currentIndex < 0) { alert('Create or select a post first.'); return; }
  applyFormToCurrent();
  renderList(listSearch.value);
  alert('Saved (in memory). Use Export JSON to download and commit to GitHub.');
});

// Auto-generate slug from title when empty
fields.title.addEventListener('input', ()=>{
  if (!fields.slug.value.trim()) fields.slug.value = slugify(fields.title.value);
});

// Load existing posts.json
fetch('../content/posts.json').then(r=>r.json()).then(data=>{
  posts = data; renderList();
});
</script>
</body>
</html>
